# HW4 — gcloud commands for manual copy-paste
# VMs use Ubuntu 25.10 minimal (questing): same image for VM1, VM2, VM3.
# Set these variables first (or substitute in commands):
export PROJECT_ID=cs528-jm
export ZONE=us-central1-c
export REGION=us-central1
export BUCKET_NAME=jweb-content
export FORBIDDEN_TOPIC=jweb-forbidden
export FORBIDDEN_SUB=jweb-forbidden-sub
export SA_WEB_NAME=jweb-file-server-sa
export SA_WEB_EMAIL=${SA_WEB_NAME}@${PROJECT_ID}.iam.gserviceaccount.com
export VM_WEB_NAME=jweb-web-server
export VM_CLIENT_NAME=jweb-client
export VM_SUB_NAME=jweb-forbidden-subscriber
export STATIC_IP_NAME=jweb-web-ip

# --- 1. Set project and zone ---
gcloud config set project ${PROJECT_ID}
gcloud config set compute/zone ${ZONE}

# --- 2. Enable APIs ---
gcloud services enable compute.googleapis.com storage.googleapis.com pubsub.googleapis.com logging.googleapis.com

# --- 2b. Allow ports 80 and 8080 to VMs with tag http-server (so curl to VM1 works) ---
# If the rule already exists, delete it first: gcloud compute firewall-rules delete allow-jweb-http --quiet
gcloud compute firewall-rules create allow-jweb-http --project=${PROJECT_ID} --network=default --allow tcp:80,tcp:8080 --source-ranges 0.0.0.0/0 --target-tags http-server --description "HW4 web server"

# --- 3. Create service account for web server (VM1) ---
# If you already have this SA from HW3 (jweb-file-server-sa), skip this step.
gcloud iam service-accounts create ${SA_WEB_NAME} --display-name="jweb HW4 file server VM"

# --- 4. Create Pub/Sub topic and subscription (same as HW3) ---
# If you already have the topic and subscription from HW3, skip this step.
gcloud pubsub topics create ${FORBIDDEN_TOPIC}
gcloud pubsub subscriptions create ${FORBIDDEN_SUB} --topic=${FORBIDDEN_TOPIC}

# --- 5. Grant web server SA: read bucket + publish to topic + write logs ---
gcloud storage buckets add-iam-policy-binding gs://${BUCKET_NAME} --member="serviceAccount:${SA_WEB_EMAIL}" --role="roles/storage.objectViewer"
gcloud pubsub topics add-iam-policy-binding ${FORBIDDEN_TOPIC} --member="serviceAccount:${SA_WEB_EMAIL}" --role="roles/pubsub.publisher"
gcloud projects add-iam-policy-binding ${PROJECT_ID} --member="serviceAccount:${SA_WEB_EMAIL}" --role="roles/logging.logWriter"

# --- 6. Grant same SA: subscribe + write bucket (for second service on VM3) ---
gcloud pubsub subscriptions add-iam-policy-binding ${FORBIDDEN_SUB} --member="serviceAccount:${SA_WEB_EMAIL}" --role="roles/pubsub.subscriber"
gcloud storage buckets add-iam-policy-binding gs://${BUCKET_NAME} --member="serviceAccount:${SA_WEB_EMAIL}" --role="roles/storage.objectUser"

# --- 7. Reserve static IP for web server (region must match zone) ---
gcloud compute addresses create ${STATIC_IP_NAME} --project=${PROJECT_ID} --region=${REGION}

# Get the reserved IP and set for VM create (run before step 8):
export WEB_STATIC_IP=$(gcloud compute addresses describe ${STATIC_IP_NAME} --region=${REGION} --format='get(address)')

# --- 8. Create VM1 — web server (smallest: e2-micro), static IP, startup script ---
gcloud compute instances create ${VM_WEB_NAME} \
  --project=${PROJECT_ID} \
  --zone=${ZONE} \
  --machine-type=e2-micro \
  --network-interface=network-tier=PREMIUM,stack-type=IPV4_ONLY,subnet=default,address=${WEB_STATIC_IP} \
  --maintenance-policy=MIGRATE \
  --provisioning-model=STANDARD \
  --service-account=${SA_WEB_EMAIL} \
  --scopes=https://www.googleapis.com/auth/cloud-platform \
  --tags=http-server,https-server \
  --create-disk=auto-delete=yes,boot=yes,device-name=${VM_WEB_NAME},image=projects/ubuntu-os-cloud/global/images/ubuntu-minimal-2510-questing-amd64-v20260225,mode=rw,size=10,type=pd-balanced \
  --metadata-from-file startup-script=/Users/joshmayer/Developer/BU/spring26/cs528/jweb/hwk4/first_service/startup-server.sh

# --- 9. Create VM2 — client (Ubuntu 24.04 for newer glibc if using http-client binary) ---
gcloud compute instances create ${VM_CLIENT_NAME} \
  --project=${PROJECT_ID} \
  --zone=${ZONE} \
  --machine-type=e2-micro \
  --network-interface=network-tier=PREMIUM,stack-type=IPV4_ONLY,subnet=default \
  --maintenance-policy=MIGRATE \
  --provisioning-model=STANDARD \
  --tags=http-server,https-server \
  --create-disk=auto-delete=yes,boot=yes,device-name=${VM_CLIENT_NAME},image=projects/ubuntu-os-cloud/global/images/ubuntu-minimal-2510-questing-amd64-v20260225,mode=rw,size=10,type=pd-balanced

# --- 10. Create VM3 — forbidden-country subscriber (second service), startup script ---
gcloud compute instances create ${VM_SUB_NAME} \
  --project=${PROJECT_ID} \
  --zone=${ZONE} \
  --machine-type=e2-micro \
  --network-interface=network-tier=PREMIUM,stack-type=IPV4_ONLY,subnet=default \
  --maintenance-policy=MIGRATE \
  --provisioning-model=STANDARD \
  --service-account=${SA_WEB_EMAIL} \
  --scopes=https://www.googleapis.com/auth/cloud-platform \
  --create-disk=auto-delete=yes,boot=yes,device-name=${VM_SUB_NAME},image=projects/ubuntu-os-cloud/global/images/ubuntu-minimal-2510-questing-amd64-v20260225,mode=rw,size=10,type=pd-balanced \
  --metadata-from-file startup-script=/Users/joshmayer/Developer/BU/spring26/cs528/jweb/hwk4/second_service/startup-subscriber.sh

# --- Optional: teardown (delete VMs and release static IP) ---
# gcloud compute instances delete ${VM_WEB_NAME} ${VM_CLIENT_NAME} ${VM_SUB_NAME} --zone=${ZONE} --quiet
# gcloud compute addresses delete ${STATIC_IP_NAME} --region=${REGION} --quiet
